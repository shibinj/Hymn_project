<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worship Service Planner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h1 { color: #2d3748; margin-bottom: 10px; font-size: 24px; }
        .subtitle { color: #6c757d; margin-bottom: 20px; font-size: 14px; }
        .service-info { background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .service-info > div { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .service-info label { display: block; font-weight: 600; margin-bottom: 5px; color: #2d3748; font-size: 13px; }
        .service-info input, .service-info select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .controls { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; }
        button:hover { background: #5568d3; }
        button:active { transform: scale(0.98); }
        select { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; }
        .service-section { background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .section-title { font-size: 15px; font-weight: 600; color: #2d3748; margin-bottom: 12px; }
        .song-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .song-number { font-weight: 700; color: #667eea; font-size: 16px; display: block; margin-bottom: 5px; }
        .song-name { color: #2d3748; display: block; margin-bottom: 5px; font-size: 14px; }
        .song-collection { font-size: 11px; color: #6c757d; background: #e2e8f0; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 8px; }
        .manual-input { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .manual-input input { padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; flex: 1; min-width: 100px; font-size: 14px; }
        .manual-input button { padding: 10px 16px; font-size: 13px; }
        .print-btn { background: #48bb78; }
        .print-btn:hover { background: #38a169; }
        .save-btn { background: #ed8936; }
        .save-btn:hover { background: #dd6b20; }
        .history-btn { background: #805ad5; }
        .history-btn:hover { background: #6b46c1; }
        .whatsapp-btn { background: #25d366; }
        .whatsapp-btn:hover { background: #1da851; }
        .warning { color: #e53e3e; font-size: 11px; margin-top: 5px; }
        .recently-used { font-size: 12px; color: #718096; margin-top: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; padding: 10px; }
        .modal-content { background: white; margin: 20px auto; padding: 20px; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { font-size: 20px; }
        .close-btn { font-size: 28px; cursor: pointer; color: #6c757d; line-height: 1; }
        .close-btn:hover { color: #2d3748; }
        .history-item { background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea; }
        .history-date { font-weight: 700; color: #2d3748; font-size: 14px; }
        .history-theme { color: #667eea; font-size: 13px; margin: 5px 0; }
        .history-songs { font-size: 12px; color: #4a5568; margin-top: 8px; }
        .filter-section { background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .filter-section label { font-weight: 600; font-size: 13px; }
        .filter-section input { padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; margin: 5px 5px 5px 0; font-size: 13px; }
        .filter-section button { padding: 8px 12px; font-size: 13px; margin: 5px 5px 5px 0; }
        #syncStatus { font-size: 11px; }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 15px; border-radius: 10px; }
            h1 { font-size: 20px; }
            .subtitle { font-size: 12px; }
            .controls { gap: 6px; }
            button { padding: 8px 12px; font-size: 12px; }
            select { font-size: 12px; width: 100%; }
            .service-section { padding: 12px; }
            .section-title { font-size: 14px; }
            .song-item { padding: 10px; }
            .song-number { font-size: 15px; }
            .song-name { font-size: 13px; }
            .modal-content { margin: 10px; padding: 15px; }
            .modal-header h2 { font-size: 18px; }
            .filter-section input { width: 100%; margin: 5px 0; }
            .filter-section button { width: 48%; }
        }
        
        @media (min-width: 769px) {
            .service-info > div { grid-template-columns: 1fr 1fr 1fr; }
        }
        
        @media print {
            body { background: white; padding: 0; }
            .controls, .modal, button, .recently-used { display: none !important; }
            .container { box-shadow: none; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Worship Service Planner</h1>
        <p class="subtitle">Generate random song selections for Sunday worship</p>
        
        <div class="service-info" style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2d3748;">üìÖ Service Date</label>
                    <input type="date" id="serviceDate" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" />
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2d3748;">üìñ Theme of the Week</label>
                    <input type="text" id="serviceTheme" placeholder="Enter theme..." style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" />
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2d3748;">üîó GitHub Gist ID <span style="font-size: 11px; font-weight: normal; color: #6c757d;">(optional)</span></label>
                    <input type="text" id="gistId" placeholder="Enter Gist ID..." style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" />
                </div>
            </div>
            <div id="syncStatus" style="margin-top: 10px; font-size: 12px; color: #6c757d;"></div>
        </div>
        
        <div class="controls">
            <button onclick="generateService()">üé≤ Generate New Service</button>
            <button class="save-btn" onclick="saveService()">üíæ Save Service</button>
            <button class="whatsapp-btn" onclick="shareToWhatsApp()">üì± Share to WhatsApp</button>
            <button class="history-btn" onclick="showHistory()">üìú View History</button>
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
            <button onclick="setupGist()" style="background: #4299e1;">‚öôÔ∏è Setup Cloud Sync</button>
            <button onclick="syncFromGist()" style="background: #48bb78;">üîÑ Sync Now</button>
            <select id="offertoryConvention">
                <option value="alternate">Alternate Conventions</option>
                <option value="maramon-2025">Maramon 2025</option>
                <option value="maramon-2026">Maramon 2026</option>
                <option value="kottarakara-2025">Kottarakara 2025</option>
                <option value="kottarakara-2026">Kottarakara 2026</option>
            </select>
        </div>
        
        <div id="serviceOrder"></div>
        
        <div class="recently-used" id="recentlyUsed"></div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Service History</h2>
                <span class="close-btn" onclick="closeHistory()">&times;</span>
            </div>
            
            <div class="filter-section">
                <label><strong>Search by Song Number:</strong></label><br/>
                <input type="text" id="searchSongNum" placeholder="Enter song number (e.g., 25 or DOX-I)" style="width: 200px;" />
                <button onclick="searchBySong()">üîç Search Song</button>
                <button onclick="clearSearch()">Clear</button>
            </div>
            
            <div class="filter-section">
                <label><strong>Filter by Date Range:</strong></label><br/>
                <input type="date" id="filterStartDate" placeholder="Start Date" />
                <input type="date" id="filterEndDate" placeholder="End Date" />
                <button onclick="filterHistory()">üîç Filter</button>
                <button onclick="clearFilter()">Clear</button>
            </div>
            
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        let hymns = [];
        let conventions = {};
        let lastConvention = 'kottarakara';
        let serviceHistory = [];
        
        // CONFIGURE THIS: Your GitHub Gist ID (leave empty to disable cloud sync)
        const SHARED_GIST_ID = 'db9382e61d3f976d88eb0c9d0a643b7d'; // Paste your Gist ID here, e.g., 'abc123def456'
        
        let gistId = SHARED_GIST_ID || localStorage.getItem('gistId') || '';
        let gistToken = localStorage.getItem('gistToken') || '';

        // Song categories
        const categories = {
            opening: [16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,429,430],
            bibleReading: [45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,431,432,433,434,435,436,437,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,452,453,454,455,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,409,410,411,412,413,414,415,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371],
            qurbana: [166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,220,221,222,223,224,225,226,227,228,233,234,235,236,237,238,239,240,241,251,252,253,254,266,267,268,269,270,271,272,273,274,313,314,315,316,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500]
        };

        async function loadData() {
            hymns = await fetch('data/kristheeya-keerthanangal.json').then(r => r.json());
            conventions['maramon-2025'] = await fetch('data/maramon-2025.json').then(r => r.json());
            conventions['maramon-2026'] = await fetch('data/maramon-2026.json').then(r => r.json());
            conventions['kottarakara-2025'] = await fetch('data/kottarakara-2025.json').then(r => r.json());
            conventions['kottarakara-2026'] = await fetch('data/kottarakara-2026.json').then(r => r.json());
            
            // Auto-configure Gist ID if set in code
            if (SHARED_GIST_ID) {
                gistId = SHARED_GIST_ID;
                document.getElementById('gistId').value = gistId;
                document.getElementById('gistId').disabled = true;
                
                // Only prompt for token if not already dismissed
                const tokenDismissed = localStorage.getItem('tokenPromptDismissed');
                
                if (!gistToken && !tokenDismissed) {
                    // Show a less intrusive prompt
                    setTimeout(() => {
                        const enableSync = confirm('üîÑ Enable Cloud Sync?\n\nSync your worship services across all devices.\n\nClick OK to set up (requires GitHub token for editing)\nClick Cancel to view-only mode (no token needed)');
                        
                        if (enableSync) {
                            const token = prompt('Enter your GitHub Personal Access Token:\n\n1. Go to: https://github.com/settings/tokens\n2. Generate new token (classic)\n3. Check "gist" permission\n4. Copy and paste here\n\n(Stored locally in your browser only)');
                            
                            if (token) {
                                gistToken = token;
                                localStorage.setItem('gistToken', gistToken);
                                syncFromGist();
                            } else {
                                localStorage.setItem('tokenPromptDismissed', 'true');
                                updateSyncStatus('‚ÑπÔ∏è View-only mode. You can view history but cannot save services.');
                                syncFromGist(); // Sync without token for read-only
                            }
                        } else {
                            localStorage.setItem('tokenPromptDismissed', 'true');
                            updateSyncStatus('‚ÑπÔ∏è View-only mode. You can view history but cannot save services.');
                            syncFromGist(); // Sync without token for read-only
                        }
                    }, 1000);
                } else if (gistToken) {
                    await syncFromGist();
                } else {
                    // No token but dismissed - still try to sync for read-only
                    await syncFromGist();
                }
            } else if (gistId) {
                document.getElementById('gistId').value = gistId;
                await syncFromGist();
            }
            
            // Always load local data as fallback
            if (serviceHistory.length === 0) {
                serviceHistory = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
            }
            
            displayRecentlyUsed();
        }

        async function syncFromGist() {
            if (!gistId) return;
            
            try {
                updateSyncStatus('üîÑ Syncing from cloud...');
                
                // Try with token first (if available)
                const headers = gistToken ? {
                    'Authorization': `token ${gistToken}`
                } : {};
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch Gist');
                }
                
                const gist = await response.json();
                const file = gist.files['worship-service-history.json'];
                
                if (file) {
                    serviceHistory = JSON.parse(file.content);
                    localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
                    updateSyncStatus(`‚úÖ Synced ${serviceHistory.length} services from cloud`);
                } else {
                    updateSyncStatus('‚ö†Ô∏è No data found in Gist');
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('‚ùå Sync failed - using local data');
                serviceHistory = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
            }
        }

        async function syncToGist() {
            if (!gistId || !gistToken) {
                return false;
            }
            
            try {
                updateSyncStatus('üîÑ Saving to cloud...');
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${gistToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'worship-service-history.json': {
                                content: JSON.stringify(serviceHistory, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update Gist');
                }
                
                updateSyncStatus(`‚úÖ Saved to cloud (${serviceHistory.length} services)`);
                return true;
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('‚ùå Cloud save failed - saved locally only');
                return false;
            }
        }

        function updateSyncStatus(message) {
            document.getElementById('syncStatus').textContent = message;
        }

        function setupGist() {
            const newGistId = document.getElementById('gistId').value.trim();
            
            if (!newGistId) {
                alert('Please enter a Gist ID');
                return;
            }
            
            const token = prompt('Enter your GitHub Personal Access Token (with gist permission):\n\nThis will be stored locally in your browser.');
            
            if (!token) {
                return;
            }
            
            gistId = newGistId;
            gistToken = token;
            
            localStorage.setItem('gistId', gistId);
            localStorage.setItem('gistToken', gistToken);
            
            alert('‚úÖ GitHub Gist configured! Data will now sync automatically.');
            syncFromGist();
        }

        function wasRecentlyUsed(songNum, category) {
            const twoMonthsAgo = Date.now() - (60 * 24 * 60 * 60 * 1000);
            return serviceHistory.some(service => 
                service.date > twoMonthsAgo && 
                service.songs.some(s => s.number === songNum && s.category === category)
            );
        }

        function getFrequentSongs(category, count = 5) {
            // Get all songs from this category in history
            const categoryHistory = serviceHistory
                .flatMap(s => s.songs.filter(song => song.category === category))
                .map(s => s.number);
            
            if (categoryHistory.length === 0) return [];
            
            // Count frequency
            const frequency = {};
            categoryHistory.forEach(num => {
                frequency[num] = (frequency[num] || 0) + 1;
            });
            
            // Return top picks (not recently used)
            return Object.entries(frequency)
                .sort((a, b) => b[1] - a[1])
                .map(([num]) => isNaN(num) ? num : parseInt(num))
                .filter(num => !wasRecentlyUsed(num, category))
                .slice(0, count);
        }

        function getRandomSong(numbers, category) {
            // First try frequent picks from history
            const frequentPicks = getFrequentSongs(category, 3);
            const validFrequent = frequentPicks.filter(num => numbers.includes(num));
            
            if (validFrequent.length > 0 && Math.random() > 0.3) {
                // 70% chance to use a frequent pick
                const num = validFrequent[Math.floor(Math.random() * validFrequent.length)];
                return hymns.find(s => s.number === num);
            }
            
            // Otherwise pick randomly from available songs
            let availableSongs = numbers.filter(num => !wasRecentlyUsed(num, category));
            if (availableSongs.length === 0) availableSongs = numbers;
            
            const num = availableSongs[Math.floor(Math.random() * availableSongs.length)];
            return hymns.find(s => s.number === num) || hymns[Math.floor(Math.random() * hymns.length)];
        }

        function getRandomConventionSong(collection) {
            const songs = conventions[collection];
            
            // Check history for frequently used offertory songs from this collection
            const frequentPicks = getFrequentSongs('offertory', 5);
            const validFrequent = songs.filter(s => frequentPicks.includes(s.number));
            
            if (validFrequent.length > 0 && Math.random() > 0.3) {
                return validFrequent[Math.floor(Math.random() * validFrequent.length)];
            }
            
            let availableSongs = songs.filter(s => !wasRecentlyUsed(s.number, 'offertory'));
            if (availableSongs.length === 0) availableSongs = songs;
            
            return availableSongs[Math.floor(Math.random() * availableSongs.length)];
        }

        function getDoxology() {
            const doxSongs = hymns.filter(s => typeof s.number === 'string' && s.number.startsWith('DOX'));
            
            // Check for frequently used doxology
            const frequentPicks = getFrequentSongs('doxology', 3);
            const validFrequent = doxSongs.filter(s => frequentPicks.includes(s.number));
            
            if (validFrequent.length > 0 && Math.random() > 0.3) {
                return validFrequent[Math.floor(Math.random() * validFrequent.length)];
            }
            
            let availableSongs = doxSongs.filter(s => !wasRecentlyUsed(s.number, 'doxology'));
            if (availableSongs.length === 0) availableSongs = doxSongs;
            
            return availableSongs[Math.floor(Math.random() * availableSongs.length)];
        }

        function generateService() {
            const offertoryPref = document.getElementById('offertoryConvention').value;
            
            let offertoryConvention;
            if (offertoryPref === 'alternate') {
                const year = new Date().getFullYear();
                lastConvention = lastConvention === 'kottarakara' ? 'maramon' : 'kottarakara';
                offertoryConvention = `${lastConvention}-${year}`;
                if (!conventions[offertoryConvention]) {
                    offertoryConvention = `${lastConvention}-2025`;
                }
            } else {
                offertoryConvention = offertoryPref;
            }

            window.currentService = [
                { title: '1. Opening Hymn', song: getRandomSong(categories.opening, 'opening'), collection: 'Kristheeya Keerthanangal', category: 'opening' },
                { title: '2. Song for Bible Reading', song: getRandomSong(categories.bibleReading, 'bibleReading'), collection: 'Kristheeya Keerthanangal', category: 'bibleReading' },
                { title: '3. Birthday/Anniversary Song', song: null, collection: 'Manual', category: 'celebration', manual: true },
                { title: '4. Offertory Song', song: getRandomConventionSong(offertoryConvention), collection: offertoryConvention, category: 'offertory' },
                { title: '5. Holy Qurbana - Song 1', song: getRandomSong(categories.qurbana, 'qurbana1'), collection: 'Kristheeya Keerthanangal', category: 'qurbana1' },
                { title: '6. Holy Qurbana - Song 2', song: getRandomSong(categories.qurbana, 'qurbana2'), collection: 'Kristheeya Keerthanangal', category: 'qurbana2' },
                { title: '7. Doxology', song: getDoxology(), collection: 'Doxology', category: 'doxology' }
            ];

            displayService(window.currentService);
        }

        function getSuggestedCelebrationSongs() {
            // Analyze history to find patterns
            const celebrationHistory = serviceHistory
                .flatMap(s => s.songs.filter(song => song.category === 'celebration'))
                .map(s => s.number);
            
            if (celebrationHistory.length === 0) {
                // Default suggestions from both hymns and conventions
                return [200, 205, 210, 215, 220, 225, 230, 235, 240, 245, 250];
            }
            
            // Count frequency
            const frequency = {};
            celebrationHistory.forEach(num => {
                frequency[num] = (frequency[num] || 0) + 1;
            });
            
            // Get top picks
            const topPicks = Object.entries(frequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([num]) => isNaN(num) ? num : parseInt(num));
            
            // Find similar range songs (not recently used) from hymns
            const numericHistory = celebrationHistory.filter(n => !isNaN(n));
            const avgNum = numericHistory.length > 0 ? 
                numericHistory.reduce((a, b) => a + b, 0) / numericHistory.length : 200;
            
            const rangeSongs = hymns
                .filter(s => typeof s.number === 'number' && 
                            Math.abs(s.number - avgNum) < 50 &&
                            !wasRecentlyUsed(s.number, 'celebration'))
                .map(s => s.number)
                .slice(0, 3);
            
            // Add some convention songs
            const conventionSuggestions = Object.values(conventions)
                .flat()
                .filter(s => !wasRecentlyUsed(s.number, 'celebration'))
                .slice(0, 2)
                .map(s => s.number);
            
            return [...new Set([...topPicks, ...rangeSongs, ...conventionSuggestions])].slice(0, 8);
        }

        function setManualSong(index, songNum) {
            // Search in hymns first
            let song = hymns.find(s => s.number == songNum);
            let collection = 'Kristheeya Keerthanangal';
            
            // If not found, search in all conventions
            if (!song) {
                for (const [collName, songs] of Object.entries(conventions)) {
                    song = songs.find(s => s.number == songNum);
                    if (song) {
                        collection = collName;
                        break;
                    }
                }
            }
            
            if (song) {
                window.currentService[index].song = song;
                window.currentService[index].collection = collection;
                displayService(window.currentService);
            } else {
                alert('Song not found!');
            }
        }

        function setManualSongWithCollection(index) {
            const collectionSelect = document.getElementById(`celebrationCollection${index}`);
            const songNumInput = document.getElementById(`manual${index}`);
            
            const selectedCollection = collectionSelect.value;
            const songNum = songNumInput.value;
            
            if (!songNum) {
                alert('Please enter a song number!');
                return;
            }
            
            let song;
            if (selectedCollection === 'kristheeya-keerthanangal') {
                song = hymns.find(s => s.number == songNum);
            } else {
                song = conventions[selectedCollection].find(s => s.number == songNum);
            }
            
            if (song) {
                window.currentService[index].song = song;
                window.currentService[index].collection = selectedCollection === 'kristheeya-keerthanangal' ? 'Kristheeya Keerthanangal' : selectedCollection;
                displayService(window.currentService);
            } else {
                alert(`Song #${songNum} not found in ${selectedCollection}!`);
            }
        }

        function displayService(service) {
            const html = service.map((item, index) => {
                if (item.manual && !item.song) {
                    const suggestions = getSuggestedCelebrationSongs();
                    const suggestionButtons = suggestions.map(num => {
                        const song = hymns.find(s => s.number === num) || 
                                     Object.values(conventions).flat().find(s => s.number === num);
                        return song ? `<button onclick="setManualSong(${index}, ${num})" style="font-size: 12px; padding: 6px 12px; margin: 2px;">#${num}</button>` : '';
                    }).join('');
                    
                    return `
                        <div class="service-section">
                            <div class="section-title">${item.title}</div>
                            <div class="song-item">
                                <div class="manual-input">
                                    <select id="celebrationCollection${index}" style="flex: 1; min-width: 150px;">
                                        <option value="kristheeya-keerthanangal">Kristheeya Keerthanangal</option>
                                        <option value="maramon-2025">Maramon 2025</option>
                                        <option value="maramon-2026">Maramon 2026</option>
                                        <option value="kottarakara-2025">Kottarakara 2025</option>
                                        <option value="kottarakara-2026">Kottarakara 2026</option>
                                    </select>
                                    <input type="number" id="manual${index}" placeholder="Song #" style="width: 80px;" />
                                    <button onclick="setManualSongWithCollection(${index})">Set Song</button>
                                </div>
                            </div>
                            ${suggestions.length > 0 ? `<div style="margin-top: 10px; font-size: 12px; color: #718096;">üí° Smart Suggestions: ${suggestionButtons}</div>` : ''}
                        </div>
                    `;
                }
                
                const recentWarning = wasRecentlyUsed(item.song.number, item.category) ? 
                    '<div class="warning">‚ö†Ô∏è Used in last 2 months</div>' : '';
                
                // For Birthday/Anniversary, show collection info and edit with dropdown
                const editButton = item.category === 'celebration' ? 
                    `<button onclick="editCelebrationSong(${index})" style="padding: 6px 12px; font-size: 12px; background: #ed8936;">‚úèÔ∏è Edit</button>` :
                    `<button onclick="editSong(${index})" style="padding: 6px 12px; font-size: 12px; background: #ed8936;">‚úèÔ∏è Edit</button>`;
                
                return `
                    <div class="service-section">
                        <div class="section-title">${item.title}</div>
                        <div class="song-item">
                            <span class="song-number">#${item.song.number}</span>
                            <span class="song-name">${item.song.name}${item.song.name2 ? ' - ' + item.song.name2 : ''}</span>
                            <span class="song-collection">${item.collection}</span>
                            ${editButton}
                        </div>
                        ${recentWarning}
                    </div>
                `;
            }).join('');
            
            document.getElementById('serviceOrder').innerHTML = html;
        }

        function editSong(index) {
            const item = window.currentService[index];
            const currentSong = item.song;
            
            // Special handling for Offertory - show collection selector
            if (item.category === 'offertory') {
                const collection = prompt(
                    `Current: #${currentSong.number} - ${currentSong.name}\n\n` +
                    `Choose collection:\n` +
                    `1 = Maramon 2025\n` +
                    `2 = Maramon 2026\n` +
                    `3 = Kottarakara 2025\n` +
                    `4 = Kottarakara 2026\n\n` +
                    `Enter collection number (1-4):`
                );
                
                if (!collection) return;
                
                const collectionMap = {
                    '1': 'maramon-2025',
                    '2': 'maramon-2026',
                    '3': 'kottarakara-2025',
                    '4': 'kottarakara-2026'
                };
                
                const selectedCollection = collectionMap[collection];
                if (!selectedCollection) {
                    alert('Invalid collection number!');
                    return;
                }
                
                const songNum = prompt(`Enter song number from ${selectedCollection}:`);
                if (!songNum) return;
                
                const song = conventions[selectedCollection].find(s => s.number == songNum);
                if (song) {
                    window.currentService[index].song = song;
                    window.currentService[index].collection = selectedCollection;
                    displayService(window.currentService);
                } else {
                    alert(`Song #${songNum} not found in ${selectedCollection}!`);
                }
                return;
            }
            
            // Special handling for Doxology - convert number to DOX-Roman
            if (item.category === 'doxology') {
                const input = prompt(
                    `Current: ${currentSong.number} - ${currentSong.name}\n\n` +
                    `Enter doxology number:\n` +
                    `- Type number (1-13) for DOX-I to DOX-XIII\n` +
                    `- Or type full name (e.g., DOX-V):`
                );
                
                if (!input) return;
                
                let doxNumber;
                if (/^\d+$/.test(input)) {
                    // Convert number to Roman
                    const romanMap = ['', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII', 'XIII'];
                    const num = parseInt(input);
                    if (num >= 1 && num <= 13) {
                        doxNumber = `DOX-${romanMap[num]}`;
                    }
                } else {
                    doxNumber = input.toUpperCase();
                }
                
                if (doxNumber) {
                    const song = hymns.find(s => s.number === doxNumber);
                    if (song) {
                        window.currentService[index].song = song;
                        displayService(window.currentService);
                    } else {
                        alert(`Doxology ${doxNumber} not found!`);
                    }
                } else {
                    alert('Invalid doxology number!');
                }
                return;
            }
            
            // Birthday/Anniversary - search all collections
            if (item.category === 'celebration') {
                const input = prompt(
                    `Current: #${currentSong.number} - ${currentSong.name}\n\n` +
                    `Enter song number:\n` +
                    `- From Kristheeya Keerthanangal (e.g., 220)\n` +
                    `- From any Convention (e.g., 13, 80):\n\n` +
                    `Note: System will search all collections`
                );
                
                if (!input) return;
                
                // Search in hymns first
                let song = hymns.find(s => s.number == input);
                let collection = 'Kristheeya Keerthanangal';
                
                // If not found, search all conventions
                if (!song) {
                    for (const [collName, songs] of Object.entries(conventions)) {
                        song = songs.find(s => s.number == input);
                        if (song) {
                            collection = collName;
                            break;
                        }
                    }
                }
                
                if (song) {
                    window.currentService[index].song = song;
                    window.currentService[index].collection = collection;
                    displayService(window.currentService);
                } else {
                    alert(`Song #${input} not found in any collection!`);
                }
                return;
            }
            
            // Default handling for other categories
            const newNum = prompt(`Current: #${currentSong.number} - ${currentSong.name}\n\nEnter new song number:`);
            
            if (newNum) {
                setManualSong(index, newNum);
            }
        }

        function editCelebrationSong(index) {
            const item = window.currentService[index];
            const currentSong = item.song;
            
            // Show collection selector
            const collection = prompt(
                `Current: #${currentSong.number} - ${currentSong.name}\nFrom: ${item.collection}\n\n` +
                `Choose collection:\n` +
                `1 = Kristheeya Keerthanangal\n` +
                `2 = Maramon 2025\n` +
                `3 = Maramon 2026\n` +
                `4 = Kottarakara 2025\n` +
                `5 = Kottarakara 2026\n\n` +
                `Enter collection number (1-5):`
            );
            
            if (!collection) return;
            
            const collectionMap = {
                '1': 'kristheeya-keerthanangal',
                '2': 'maramon-2025',
                '3': 'maramon-2026',
                '4': 'kottarakara-2025',
                '5': 'kottarakara-2026'
            };
            
            const selectedCollection = collectionMap[collection];
            if (!selectedCollection) {
                alert('Invalid collection number!');
                return;
            }
            
            const songNum = prompt(`Enter song number from ${selectedCollection}:`);
            if (!songNum) return;
            
            let song;
            if (selectedCollection === 'kristheeya-keerthanangal') {
                song = hymns.find(s => s.number == songNum);
            } else {
                song = conventions[selectedCollection].find(s => s.number == songNum);
            }
            
            if (song) {
                window.currentService[index].song = song;
                window.currentService[index].collection = selectedCollection === 'kristheeya-keerthanangal' ? 'Kristheeya Keerthanangal' : selectedCollection;
                displayService(window.currentService);
            } else {
                alert(`Song #${songNum} not found in ${selectedCollection}!`);
            }
        }

        function saveService() {
            if (!window.currentService || !window.currentService[2].song) {
                alert('Please set Birthday/Anniversary song before saving!');
                return;
            }

            const serviceDate = document.getElementById('serviceDate').value;
            const serviceTheme = document.getElementById('serviceTheme').value;

            if (!serviceDate || !serviceTheme) {
                alert('Please enter service date and theme!');
                return;
            }

            const service = {
                date: new Date(serviceDate).getTime(),
                theme: serviceTheme,
                songs: window.currentService.map(s => ({
                    number: s.song.number,
                    name: s.song.name,
                    category: s.category
                }))
            };

            // Check if we're editing an existing service
            if (window.editingServiceIndex !== undefined) {
                serviceHistory[window.editingServiceIndex] = service;
                delete window.editingServiceIndex;
            } else {
                serviceHistory.unshift(service);
            }
            
            serviceHistory = serviceHistory.slice(0, 50); // Keep last 50 services
            
            // Save to localStorage
            localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
            
            // Sync to Gist if configured and token available
            if (gistId && gistToken) {
                syncToGist().then(success => {
                    if (success) {
                        alert('‚úÖ Service saved and synced to cloud!');
                    } else {
                        alert('‚úÖ Service saved locally (cloud sync failed)');
                    }
                    displayRecentlyUsed();
                });
            } else if (gistId && !gistToken) {
                alert('‚ö†Ô∏è View-only mode: Cannot save to cloud.\n\nYour service is saved locally only.\n\nTo enable cloud saving, click "Setup Cloud Sync" and enter your GitHub token.');
                displayRecentlyUsed();
            } else {
                alert('‚úÖ Service saved locally!');
                displayRecentlyUsed();
            }
        }

        function displayRecentlyUsed() {
            if (serviceHistory.length === 0) return;
            
            const recent = serviceHistory.slice(0, 5).map(s => {
                const date = new Date(s.date).toLocaleDateString();
                const theme = s.theme || 'No theme';
                const songs = s.songs.map(song => `#${song.number}`).join(', ');
                return `<div><strong>${date}</strong> - ${theme}<br/><span style="font-size: 11px;">${songs}</span></div>`;
            }).join('<hr style="margin: 10px 0; border: none; border-top: 1px solid #e2e8f0;">');
            
            document.getElementById('recentlyUsed').innerHTML = `<h3>Recently Used Services:</h3>${recent}`;
        }

        // Set today's date by default and setup auto-sync
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('serviceDate').value = today;
            
            // Auto-sync every 5 minutes if Gist is configured
            if (gistId && gistToken) {
                setInterval(() => {
                    syncFromGist();
                }, 5 * 60 * 1000);
            }
        });

        function showHistory() {
            document.getElementById('historyModal').style.display = 'block';
            displayFullHistory();
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function displayFullHistory(filtered = null) {
            const historyToShow = filtered || serviceHistory;
            
            if (historyToShow.length === 0) {
                document.getElementById('historyList').innerHTML = '<p>No services saved yet.</p>';
                return;
            }
            
            const categoryTitles = {
                'opening': 'Opening',
                'bibleReading': 'Bible Reading',
                'celebration': 'Birthday/Anniversary',
                'offertory': 'Offertory',
                'qurbana1': 'Qurbana 1',
                'qurbana2': 'Qurbana 2',
                'doxology': 'Doxology'
            };
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            const html = historyToShow.map((service, idx) => {
                const serviceDate = new Date(service.date);
                const date = serviceDate.toLocaleDateString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
                const theme = service.theme || 'No theme';
                
                const songsHtml = service.songs.map(song => 
                    `<div><strong>${categoryTitles[song.category] || song.category}:</strong> #${song.number} - ${song.name}</div>`
                ).join('');
                
                // Find original index in serviceHistory
                const originalIndex = serviceHistory.findIndex(s => s.date === service.date);
                
                // Only show edit/delete for today or future dates
                const isFutureOrToday = serviceDate >= today;
                const actionButtons = isFutureOrToday ? `
                    <div style="display: flex; gap: 5px;">
                        <button onclick="loadServiceForEdit(${originalIndex})" style="padding: 6px 12px; font-size: 12px; background: #ed8936;">‚úèÔ∏è Edit</button>
                        <button onclick="deleteService(${originalIndex})" style="padding: 6px 12px; font-size: 12px; background: #e53e3e;">üóëÔ∏è Delete</button>
                    </div>
                ` : '';
                
                return `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div class="history-date">üìÖ ${date}</div>
                                <div class="history-theme">üìñ Theme: ${theme}</div>
                            </div>
                            ${actionButtons}
                        </div>
                        <div class="history-songs">${songsHtml}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('historyList').innerHTML = html;
        }

        function loadServiceForEdit(index) {
            if (index < 0 || index >= serviceHistory.length) {
                alert('Service not found!');
                return;
            }
            
            const service = serviceHistory[index];
            
            // Confirm before loading
            const date = new Date(service.date).toLocaleDateString();
            if (!confirm(`Load service from ${date} for editing?\n\nThis will replace your current service plan.`)) {
                return;
            }
            
            // Set date and theme
            document.getElementById('serviceDate').value = new Date(service.date).toISOString().split('T')[0];
            document.getElementById('serviceTheme').value = service.theme || '';
            
            // Reconstruct service with full song objects
            window.currentService = service.songs.map(savedSong => {
                // Find the full song object
                let song = hymns.find(s => s.number == savedSong.number);
                let collection = 'Kristheeya Keerthanangal';
                
                if (!song) {
                    for (const [collName, songs] of Object.entries(conventions)) {
                        song = songs.find(s => s.number == savedSong.number);
                        if (song) {
                            collection = collName;
                            break;
                        }
                    }
                }
                
                if (!song) {
                    // Fallback if song not found
                    song = { number: savedSong.number, name: savedSong.name };
                }
                
                const categoryTitles = {
                    'opening': '1. Opening Hymn',
                    'bibleReading': '2. Song for Bible Reading',
                    'celebration': '3. Birthday/Anniversary Song',
                    'offertory': '4. Offertory Song',
                    'qurbana1': '5. Holy Qurbana - Song 1',
                    'qurbana2': '6. Holy Qurbana - Song 2',
                    'doxology': '7. Doxology'
                };
                
                return {
                    title: categoryTitles[savedSong.category],
                    song: song,
                    collection: collection,
                    category: savedSong.category,
                    manual: savedSong.category === 'celebration'
                };
            });
            
            // Store the index for updating later
            window.editingServiceIndex = index;
            
            // Close modal and display
            closeHistory();
            displayService(window.currentService);
            
            alert('‚úèÔ∏è Service loaded for editing!\n\nMake your changes and click "Save Service" to update.');
        }

        function deleteService(index) {
            if (index < 0 || index >= serviceHistory.length) {
                alert('Service not found!');
                return;
            }
            
            const service = serviceHistory[index];
            const date = new Date(service.date).toLocaleDateString();
            
            if (!confirm(`Delete service from ${date}?\n\nThis cannot be undone.`)) {
                return;
            }
            
            serviceHistory.splice(index, 1);
            localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
            
            // Sync to cloud if available
            if (gistId && gistToken) {
                syncToGist();
            }
            
            alert('‚úÖ Service deleted!');
            displayFullHistory();
            displayRecentlyUsed();
        }

        function filterHistory() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate && !endDate) {
                displayFullHistory();
                return;
            }
            
            const start = startDate ? new Date(startDate).getTime() : 0;
            const end = endDate ? new Date(endDate).getTime() + (24 * 60 * 60 * 1000) : Date.now();
            
            const filtered = serviceHistory.filter(service => 
                service.date >= start && service.date <= end
            );
            
            displayFullHistory(filtered);
        }

        function clearFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            displayFullHistory();
        }

        function searchBySong() {
            const songNum = document.getElementById('searchSongNum').value.trim();
            
            if (!songNum) {
                alert('Please enter a song number');
                return;
            }
            
            // Handle Doxology search - convert number to DOX-Roman
            let searchNumbers = [songNum];
            if (/^\d+$/.test(songNum)) {
                const num = parseInt(songNum);
                if (num >= 1 && num <= 13) {
                    const romanMap = ['', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII', 'XIII'];
                    searchNumbers.push(`DOX-${romanMap[num]}`);
                }
            }
            
            // Find song in hymns or conventions
            let songInfo = null;
            let collection = '';
            
            for (const searchNum of searchNumbers) {
                songInfo = hymns.find(s => s.number == searchNum);
                if (songInfo) {
                    collection = 'Kristheeya Keerthanangal';
                    break;
                }
                
                for (const [collName, songs] of Object.entries(conventions)) {
                    songInfo = songs.find(s => s.number == searchNum);
                    if (songInfo) {
                        collection = collName;
                        break;
                    }
                }
                if (songInfo) break;
            }
            
            if (!songInfo) {
                document.getElementById('historyList').innerHTML = `<p style="color: #e53e3e;">‚ùå Song #${songNum} not found in any collection.</p>`;
                return;
            }
            
            // Find all services that used this song (check all search numbers)
            const servicesWithSong = serviceHistory.filter(service => 
                service.songs.some(s => searchNumbers.includes(s.number.toString()))
            ).slice(0, 5); // Last 5 uses
            
            if (servicesWithSong.length === 0) {
                document.getElementById('historyList').innerHTML = `
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #2d3748;">üéµ Song #${songInfo.number} - ${songInfo.name}</h3>
                        <p style="color: #667eea; margin: 5px 0;"><strong>Collection:</strong> ${collection}</p>
                        <p style="color: #6c757d; margin-top: 15px;">‚úÖ This song has never been used in saved services.</p>
                    </div>
                `;
                return;
            }
            
            const categoryTitles = {
                'opening': 'Opening',
                'bibleReading': 'Bible Reading',
                'celebration': 'Birthday/Anniversary',
                'offertory': 'Offertory',
                'qurbana1': 'Qurbana 1',
                'qurbana2': 'Qurbana 2',
                'doxology': 'Doxology'
            };
            
            const usageHtml = servicesWithSong.map(service => {
                const date = new Date(service.date).toLocaleDateString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
                const theme = service.theme || 'No theme';
                const songUsage = service.songs.find(s => searchNumbers.includes(s.number.toString()));
                const category = categoryTitles[songUsage.category] || songUsage.category;
                
                return `
                    <div class="history-item">
                        <div class="history-date">üìÖ ${date}</div>
                        <div class="history-theme">üìñ Theme: ${theme}</div>
                        <div style="margin-top: 10px; color: #667eea; font-weight: 600;">Used as: ${category}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('historyList').innerHTML = `
                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3748;">üéµ Song #${songInfo.number} - ${songInfo.name}</h3>
                    ${songInfo.name2 ? `<p style="color: #6c757d;">${songInfo.name2}</p>` : ''}
                    <p style="color: #667eea; margin: 5px 0;"><strong>Collection:</strong> ${collection}</p>
                    <p style="color: #6c757d; margin-top: 10px;">Used ${servicesWithSong.length} time(s) in last ${serviceHistory.length} services</p>
                </div>
                <h3 style="margin-bottom: 15px;">Last ${servicesWithSong.length} Usage(s):</h3>
                ${usageHtml}
            `;
        }

        function clearSearch() {
            document.getElementById('searchSongNum').value = '';
            displayFullHistory();
        }

        function shareToWhatsApp() {
            if (!window.currentService || !window.currentService[2].song) {
                alert('Please complete the service (including Birthday/Anniversary song) before sharing!');
                return;
            }

            const serviceDate = document.getElementById('serviceDate').value;
            const serviceTheme = document.getElementById('serviceTheme').value;

            if (!serviceDate || !serviceTheme) {
                alert('Please enter service date and theme before sharing!');
                return;
            }

            const date = new Date(serviceDate).toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });

            const categoryTitles = {
                'opening': '1. Opening Hymn',
                'bibleReading': '2. Bible Reading',
                'celebration': '3. Birthday/Anniversary',
                'offertory': '4. Offertory',
                'qurbana1': '5. Holy Qurbana - Song 1',
                'qurbana2': '6. Holy Qurbana - Song 2',
                'doxology': '7. Doxology'
            };

            let message = `*WORSHIP SERVICE SONGS*\n\n`;
            message += `Date: ${date}\n`;
            message += `Theme: ${serviceTheme}\n\n`;
            message += `------------------------\n\n`;

            window.currentService.forEach(item => {
                const title = categoryTitles[item.category] || item.title;
                message += `${title}\n`;
                message += `#${item.song.number} - ${item.song.name}\n`;
                if (item.song.name2) {
                    message += `${item.song.name2}\n`;
                }
                message += `\n`;
            });

            message += `------------------------\n`;
            message += `Let us worship together in spirit and truth`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function exportHistory() {
            if (serviceHistory.length === 0) {
                alert('No service history to export!');
                return;
            }

            const dataStr = JSON.stringify(serviceHistory, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `worship-service-history-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exported ${serviceHistory.length} services!`);
        }

        function importHistory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        alert('‚ùå Invalid file format!');
                        return;
                    }

                    // Merge with existing history (avoid duplicates by date)
                    const existingDates = new Set(serviceHistory.map(s => s.date));
                    const newServices = importedData.filter(s => !existingDates.has(s.date));
                    
                    serviceHistory = [...serviceHistory, ...newServices]
                        .sort((a, b) => b.date - a.date)
                        .slice(0, 50); // Keep last 50 services
                    
                    localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
                    
                    alert(`‚úÖ Imported ${newServices.length} new services!\nTotal services: ${serviceHistory.length}`);
                    displayRecentlyUsed();
                } catch (error) {
                    alert('‚ùå Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistory();
            }
        };

        loadData().then(() => generateService());
    </script>
</body>
</html>
