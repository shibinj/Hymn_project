<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Choir Attendance Tracker</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 10px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        
        h1 { 
            color: #2d3748; 
            margin-bottom: 10px; 
            font-size: 24px; 
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-selector {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .date-selector label {
            font-weight: 600;
            margin-right: 10px;
        }
        
        .date-selector input, .date-selector select {
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 10px;
        }
        
        .section-header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }
        
        .attendance-grid {
            display: grid;
            grid-template-columns: 200px repeat(2, 80px);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .grid-header {
            font-weight: 600;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
        }
        
        .member-row {
            display: contents;
        }
        
        .member-name {
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }
        
        .attendance-btn {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .attendance-btn.present {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }
        
        .attendance-btn.absent {
            background: #f56565;
            color: white;
            border-color: #f56565;
        }
        
        .save-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 20px;
        }
        
        .save-btn:hover {
            background: #5568d3;
        }
        
        .report-controls {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .report-controls select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .report-table th, .report-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .report-table th {
            background: #f7fafc;
            font-weight: 600;
        }
        
        .report-table tr:hover {
            background: #f7fafc;
        }
        
        .percentage {
            font-weight: 600;
        }
        
        .percentage.good {
            color: #48bb78;
        }
        
        .percentage.warning {
            color: #ed8936;
        }
        
        .percentage.poor {
            color: #f56565;
        }
        
        .member-list {
            margin-top: 20px;
        }
        
        .member-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .member-item button {
            padding: 6px 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-member {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .add-member input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 10px;
            flex: 1;
        }
        
        .add-member select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 10px;
        }
        
        .add-member button {
            padding: 10px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .auth-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .auth-section input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 10px;
        }
        
        .auth-section button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .sync-section {
            background: #e6f7ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1890ff;
        }
        
        .sync-section input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 10px;
            width: 300px;
        }
        
        .sync-section button {
            padding: 10px 20px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .sync-status {
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 15px; }
            h1 { font-size: 20px; }
            .attendance-grid { grid-template-columns: 150px repeat(2, 60px); gap: 3px; }
            .tab { padding: 8px 12px; font-size: 12px; }
            .report-table { font-size: 12px; }
            .report-table th, .report-table td { padding: 8px; }
        }
        
        @media print {
            body { 
                background: white; 
                padding: 0; 
            }
            .container { 
                box-shadow: none; 
                padding: 20px; 
            }
            .tabs, .report-controls, .save-btn, 
            a[href*="admin.html"], 
            button[onclick*="manualSync"] {
                display: none !important;
            }
            .tab-content {
                display: block !important;
            }
            #attendance, #manage {
                display: none !important;
            }
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 15px;">
            <a href="../admin.html" style="background: #667eea; border: none; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; transition: all 0.3s ease; font-weight: 600;">‚Üê Admin Home</a>
        </div>
        <h1>üéµ Choir Attendance Tracker</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('attendance', event)">üìù Mark Attendance</button>
            <button class="tab" onclick="switchTab('quarterly', event)">üìä Quarterly Report</button>
            <button class="tab" onclick="switchTab('yearly', event)">üìà Yearly Report</button>
            <button class="tab" onclick="switchTab('manage', event)">‚öôÔ∏è Manage Members</button>
        </div>
        
        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content active">
            <!-- Authentication Section -->
            <div id="authSection" style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h3 style="color: #856404; margin-bottom: 15px;">üîí Authentication Required</h3>
                <p style="margin-bottom: 15px; color: #856404;">Enter your GitHub username to mark or edit attendance:</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="githubUsername" placeholder="GitHub username (e.g., octocat)" style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #ffc107; border-radius: 8px;" onkeypress="if(event.key==='Enter') authenticate(event)">
                    <button onclick="authenticate(event)" style="background: #ffc107; color: #856404; font-weight: 600; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Verify & Unlock</button>
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #856404;">
                    üí° View-only mode: You can view past attendance without authentication.
                </p>
            </div>
            
            <!-- Authenticated User Info -->
            <div id="authInfo" style="display: none; background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <span style="color: #155724; font-weight: 600;">‚úÖ Authenticated as: <span id="currentUserName"></span></span>
                <button onclick="logout()" style="background: #dc3545; color: white; padding: 8px 15px; margin-left: 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Logout</button>
            </div>
            
            <div class="date-selector">
                <label>üìÖ Select Date:</label>
                <input type="date" id="attendanceDate" onchange="loadAttendanceForDate()">
                <button class="save-btn" onclick="saveAttendance()" id="saveBtn" disabled style="opacity: 0.5; cursor: not-allowed;">üíæ Save Attendance</button>
                <button class="save-btn" onclick="manualSync()" style="background: #667eea; margin-left: 10px;">‚òÅÔ∏è Sync to Cloud</button>
                <span id="syncStatus" style="margin-left: 15px; font-size: 12px; color: #6c757d;"></span>
            </div>
            
            <div class="section-header">üë© Female Members</div>
            <div id="femaleAttendance" style="background: white; border-radius: 8px; overflow: hidden;"></div>
            
            <div class="section-header" style="margin-top: 20px;">üë® Male Members</div>
            <div id="maleAttendance" style="background: white; border-radius: 8px; overflow: hidden;"></div>
            
            <div class="section-header" style="margin-top: 20px;">üåç Occasional Attendees</div>
            <div id="occasionalAttendance" style="background: white; border-radius: 8px; overflow: hidden;"></div>
        </div>
        
        <!-- Quarterly Report Tab -->
        <div id="quarterly" class="tab-content">
            <div class="report-controls">
                <label>Select Quarter:</label>
                <select id="quarterSelect" onchange="generateQuarterlyReport()">
                    <option value="Q1">Q1 (Jan-Mar)</option>
                    <option value="Q2">Q2 (Apr-Jun)</option>
                    <option value="Q3">Q3 (Jul-Sep)</option>
                    <option value="Q4">Q4 (Oct-Dec)</option>
                </select>
                <select id="quarterYear" onchange="generateQuarterlyReport()">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <button class="export-btn" onclick="exportToPDF('quarterly')">üìÑ Export to PDF</button>
            </div>
            <div id="quarterlyReport"></div>
        </div>
        
        <!-- Yearly Report Tab -->
        <div id="yearly" class="tab-content">
            <div class="report-controls">
                <label>Select Year:</label>
                <select id="yearSelect" onchange="generateYearlyReport()">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <button class="export-btn" onclick="exportToPDF('yearly')">üìÑ Export to PDF</button>
            </div>
            <div id="yearlyReport"></div>
        </div>
        
        <!-- Manage Members Tab -->
        <div id="manage" class="tab-content">
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
                <h3 style="color: #1976d2; margin-bottom: 15px;">üìù Managing Choir Members</h3>
                <p style="margin-bottom: 10px; line-height: 1.6;">
                    To add, edit, or remove choir members, please edit the file:
                </p>
                <code style="background: white; padding: 10px; display: block; border-radius: 5px; margin: 10px 0; font-size: 14px;">
                    data/choir-members.json
                </code>
                <p style="margin-top: 15px; line-height: 1.6; font-size: 14px;">
                    <strong>Structure:</strong>
                </p>
                <pre style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto; font-size: 13px;">{
  "female": ["Name 1", "Name 2", ...],
  "male": ["Name 3", "Name 4", ...],
  "occasional": ["Name 5", "Name 6", ...]
}</pre>
                <p style="margin-top: 15px; line-height: 1.6; font-size: 14px; color: #666;">
                    üí° <strong>Tip:</strong> After editing the file, refresh this page to see the updated member list.
                </p>
                <p style="margin-top: 10px; line-height: 1.6; font-size: 14px; color: #666;">
                    ‚úÖ <strong>Benefit:</strong> Member names are stored in a file (easy to backup), while attendance data syncs to GitHub Gist.
                </p>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">Current Members</h3>
                
                <div class="section-header">üë© Female Members</div>
                <div id="femaleList" class="member-list"></div>
                
                <div class="section-header">üë® Male Members</div>
                <div id="maleList" class="member-list"></div>
                
                <div class="section-header">üåç Occasional Attendees</div>
                <div id="occasionalList" class="member-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Cloud Sync Configuration (Admin: Set these values once)
        const SHARED_GIST_ID = 'ac89975338bf079cff3f169477e3cce1'; // Admin: Set your Gist ID here
        const SHARED_GIST_TOKEN = ''; // Admin: Set your GitHub token here (optional - for write access)
        // IMPORTANT: Never commit your token to Git! Set it locally only.
        
        // Encrypted GitHub Username Whitelist (Admin: Generate using generate-whitelist.html)
        const ENCRYPTED_WHITELIST = 'FnYwNwoKBgcYfW8='; // Admin: Paste encrypted whitelist here
        const WHITELIST_KEY = 'MTC_choir_2026'; // Admin: Change this secret key
        
        let gistId = SHARED_GIST_ID;
        let gistToken = SHARED_GIST_TOKEN || localStorage.getItem('gistToken') || ''; // Load from localStorage if available
        let isAuthenticated = false;
        let currentUser = null;
        
        // Members will be loaded from JSON file
        let members = {
            female: [],
            male: [],
            occasional: []
        };
        
        // Load members from JSON file
        async function loadMembers() {
            try {
                const response = await fetch('../data/choir-members.json');
                if (response.ok) {
                    members = await response.json();
                    console.log('Members loaded from choir-members.json');
                } else {
                    console.error('Failed to load choir-members.json');
                }
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }
        
        // Attendance data structure: { 'YYYY-MM-DD': { memberName: 'P' or 'A' } }
        let attendanceData = {};
        const savedAttendance = localStorage.getItem('choirAttendance');
        if (savedAttendance) {
            attendanceData = JSON.parse(savedAttendance);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadMembers(); // Load members from JSON file first
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            renderAttendance();
            loadAttendanceForDate();
            
            // Auto-sync on load if configured
            if (gistId) {
                syncFromGist();
                // Auto-sync every 5 minutes
                setInterval(() => syncFromGist(), 5 * 60 * 1000);
            }
        });
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'quarterly') generateQuarterlyReport();
            if (tabName === 'yearly') generateYearlyReport();
            if (tabName === 'manage') renderMemberLists();
        }
        
        function renderAttendance() {
            renderSection('femaleAttendance', members.female);
            renderSection('maleAttendance', members.male);
            renderSection('occasionalAttendance', members.occasional);
        }
        
        function renderSection(containerId, memberList) {
            const container = document.getElementById(containerId);
            const date = document.getElementById('attendanceDate').value;
            
            container.innerHTML = memberList.map(name => {
                const status = attendanceData[date]?.[name] || '';
                const disabled = !isAuthenticated ? 'disabled' : '';
                const nameId = name.replace(/\s/g, '-').replace(/\./g, '');
                
                return `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #e2e8f0; gap: 10px;">
                        <div style="flex: 1; font-size: 14px; color: #2d3748;">${name}</div>
                        <select 
                            id="select-${nameId}" 
                            onchange="markAttendanceAuto('${name}')" 
                            ${disabled}
                            style="padding: 6px 10px; border: 2px solid ${status === 'P' ? '#48bb78' : status === 'A' ? '#f56565' : '#cbd5e0'}; border-radius: 6px; background: ${status === 'P' ? '#f0fff4' : status === 'A' ? '#fff5f5' : 'white'}; color: ${status === 'P' ? '#22543d' : status === 'A' ? '#742a2a' : '#4a5568'}; font-weight: 600; cursor: pointer; min-width: 80px;">
                            <option value="">-</option>
                            <option value="P" ${status === 'P' ? 'selected' : ''}>Present</option>
                            <option value="A" ${status === 'A' ? 'selected' : ''}>Absent</option>
                        </select>
                    </div>
                `;
            }).join('');
        }
        
        function markAttendanceAuto(memberName) {
            if (!isAuthenticated) {
                alert('üîí Authentication required!\n\nPlease login to mark attendance.');
                return;
            }
            
            const nameId = memberName.replace(/\s/g, '-').replace(/\./g, '');
            const selectEl = document.getElementById(`select-${nameId}`);
            const status = selectEl.value;
            
            if (!status) return; // If "-" selected, do nothing
            
            const date = document.getElementById('attendanceDate').value;
            if (!attendanceData[date]) {
                attendanceData[date] = {};
            }
            attendanceData[date][memberName] = status;
            
            // Update select styling
            if (status === 'P') {
                selectEl.style.borderColor = '#48bb78';
                selectEl.style.background = '#f0fff4';
                selectEl.style.color = '#22543d';
            } else {
                selectEl.style.borderColor = '#f56565';
                selectEl.style.background = '#fff5f5';
                selectEl.style.color = '#742a2a';
            }
            
            // Auto-save to localStorage
            localStorage.setItem('choirAttendance', JSON.stringify(attendanceData));
            updateSyncStatus('üíæ Auto-saved');
            
            // Clear status after 2 seconds
            setTimeout(() => updateSyncStatus(''), 2000);
        }
        
        function loadAttendanceForDate() {
            renderAttendance();
        }
        
        function saveAttendance() {
            if (!isAuthenticated) {
                alert('üîí Authentication required!\n\nPlease login to save attendance.');
                return;
            }
            
            localStorage.setItem('choirAttendance', JSON.stringify(attendanceData));
            
            // Always try to sync to cloud if configured
            if (gistId) {
                // If token not set, prompt for it
                if (!gistToken) {
                    const token = prompt('üîë Enter your GitHub Personal Access Token to sync:\n\n(Token needs "gist" permission)\n\nGet one at: https://github.com/settings/tokens\n\nThis will be saved in browser storage.\n\nClick Cancel to save locally only.');
                    
                    if (token && token.trim() !== '') {
                        gistToken = token.trim();
                        localStorage.setItem('gistToken', gistToken);
                    } else {
                        alert('‚úÖ Attendance saved locally only!\n\nUse "‚òÅÔ∏è Sync to Cloud" button to sync later.');
                        return;
                    }
                }
                
                updateSyncStatus('‚¨ÜÔ∏è Saving & syncing...');
                syncToGist().then(success => {
                    if (success) {
                        alert('‚úÖ Attendance saved and synced to cloud!');
                    } else {
                        alert('‚ö†Ô∏è Attendance saved locally, but cloud sync failed.\n\nToken will be cleared. Try "Sync to Cloud" button again.');
                        gistToken = '';
                        localStorage.removeItem('gistToken'); // Clear invalid token
                    }
                });
            } else {
                alert('‚ö†Ô∏è Attendance saved locally only!\n\nGist ID not configured in code (line 485).');
            }
        }
        
        function manualSync() {
            // If token is not configured, prompt for it
            if (!gistToken) {
                const token = prompt('üîë Enter your GitHub Personal Access Token:\n\n(Token needs "gist" permission)\n\nGet one at: https://github.com/settings/tokens\n\nThis will be saved in browser storage.');
                
                if (!token || token.trim() === '') {
                    alert('‚ùå Sync cancelled - no token provided');
                    return;
                }
                
                // Save the token to localStorage and memory
                gistToken = token.trim();
                localStorage.setItem('gistToken', gistToken);
            }
            
            if (!gistId) {
                alert('‚ö†Ô∏è Gist ID not configured!\n\nPlease set SHARED_GIST_ID in the code (line 485)');
                return;
            }
            
            updateSyncStatus('‚¨ÜÔ∏è Syncing to cloud...');
            syncToGist().then(success => {
                if (success) {
                    alert('‚úÖ Successfully synced to cloud!\n\nYour attendance data is now saved to GitHub Gist.');
                } else {
                    alert('‚ùå Cloud sync failed!\n\nCheck:\n‚Ä¢ Token has "gist" permission\n‚Ä¢ Gist ID is correct\n‚Ä¢ Internet connection\n\nToken will be cleared. Please try again.');
                    gistToken = '';
                    localStorage.removeItem('gistToken'); // Clear invalid token
                }
            });
        }
        
        function generateQuarterlyReport() {
            const quarter = document.getElementById('quarterSelect').value;
            const year = document.getElementById('quarterYear').value;
            
            const quarterMonths = {
                'Q1': [0, 1, 2],
                'Q2': [3, 4, 5],
                'Q3': [6, 7, 8],
                'Q4': [9, 10, 11]
            };
            
            const months = quarterMonths[quarter];
            const allMembers = [...members.female, ...members.male, ...members.occasional];
            
            const report = allMembers.map(name => {
                let present = 0, absent = 0, total = 0;
                
                Object.keys(attendanceData).forEach(date => {
                    const d = new Date(date);
                    if (d.getFullYear() == year && months.includes(d.getMonth())) {
                        const day = d.getDay();
                        if (day === 0 || day === 6) { // Sunday or Saturday
                            total++;
                            if (attendanceData[date][name] === 'P') present++;
                            if (attendanceData[date][name] === 'A') absent++;
                        }
                    }
                });
                
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
                return { name, present, absent, total, percentage };
            });
            
            displayReport('quarterlyReport', report, `${quarter} ${year} Report`);
        }
        
        function generateYearlyReport() {
            const year = document.getElementById('yearSelect').value;
            const allMembers = [...members.female, ...members.male, ...members.occasional];
            
            const report = allMembers.map(name => {
                let present = 0, absent = 0, total = 0;
                
                Object.keys(attendanceData).forEach(date => {
                    const d = new Date(date);
                    if (d.getFullYear() == year) {
                        const day = d.getDay();
                        if (day === 0 || day === 6) { // Sunday or Saturday
                            total++;
                            if (attendanceData[date][name] === 'P') present++;
                            if (attendanceData[date][name] === 'A') absent++;
                        }
                    }
                });
                
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
                return { name, present, absent, total, percentage };
            });
            
            displayReport('yearlyReport', report, `${year} Annual Report`);
        }
        
        function displayReport(containerId, data, title) {
            const container = document.getElementById(containerId);
            
            const html = `
                <h2 style="margin-bottom: 20px; color: #2d3748;">${title}</h2>
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    ${data.map(row => {
                        const presentWidth = row.total > 0 ? (row.present / row.total * 100) : 0;
                        const absentWidth = row.total > 0 ? (row.absent / row.total * 100) : 0;
                        const color = row.percentage >= 75 ? '#48bb78' : row.percentage >= 50 ? '#ed8936' : '#f56565';
                        
                        return `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: #2d3748;">${row.name}</span>
                                    <span style="font-weight: 600; color: ${color}; font-size: 16px;">${row.percentage}%</span>
                                </div>
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">
                                    Present: ${row.present} | Absent: ${row.absent} | Total: ${row.total} days
                                </div>
                                <div style="display: flex; height: 30px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                    <div style="width: ${presentWidth}%; background: #48bb78; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                                        ${row.present > 0 ? row.present : ''}
                                    </div>
                                    <div style="width: ${absentWidth}%; background: #f56565; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                                        ${row.absent > 0 ? row.absent : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Decrypt whitelist
        async function decryptWhitelist() {
            if (!ENCRYPTED_WHITELIST) {
                return [];
            }
            
            try {
                // Simple XOR decryption (obscurity, not true security)
                const key = WHITELIST_KEY;
                const encrypted = atob(ENCRYPTED_WHITELIST);
                let decrypted = '';
                
                for (let i = 0; i < encrypted.length; i++) {
                    decrypted += String.fromCharCode(encrypted.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                
                return JSON.parse(decrypted);
            } catch (error) {
                console.error('Failed to decrypt whitelist');
                return [];
            }
        }
        
        // Verify GitHub user exists
        async function verifyGitHubUser(username) {
            try {
                const response = await fetch(`https://api.github.com/users/${username}`);
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // Authentication functions
        async function authenticate(event) {
            console.log('Authenticate function called');
            const username = document.getElementById('githubUsername').value.trim();
            
            if (!username) {
                alert('Please enter your GitHub username!');
                return;
            }
            
            // Check if whitelist is configured
            if (!ENCRYPTED_WHITELIST) {
                alert('‚ö†Ô∏è Whitelist not configured!\n\nAdmin: Please generate and set the encrypted whitelist.');
                return;
            }
            
            // Show loading
            const btn = event ? event.target : document.querySelector('button[onclick*="authenticate"]');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Verifying...';
            btn.disabled = true;
            
            try {
                // Decrypt whitelist
                const whitelist = await decryptWhitelist();
                
                // Check if user is in whitelist
                if (!whitelist.includes(username.toLowerCase())) {
                    alert('‚ùå Access Denied!\n\nYour GitHub username is not authorized.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Verify user exists on GitHub
                const userExists = await verifyGitHubUser(username);
                if (!userExists) {
                    alert('‚ùå GitHub user not found!\n\nPlease check your username.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Grant access
                isAuthenticated = true;
                currentUser = username;
                
                // Update UI
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('authInfo').style.display = 'block';
                document.getElementById('currentUserName').textContent = username;
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('saveBtn').style.opacity = '1';
                document.getElementById('saveBtn').style.cursor = 'pointer';
                
                // Re-render attendance with edit buttons enabled
                renderAttendance();
                
                alert(`‚úÖ Welcome, ${username}!\n\nYou can now mark and edit attendance.`);
            } catch (error) {
                console.error('Authentication error:', error);
                alert('‚ùå Authentication failed!\n\nPlease try again.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        function logout() {
            isAuthenticated = false;
            currentUser = null;
            
            // Update UI
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('authInfo').style.display = 'none';
            document.getElementById('githubUsername').value = '';
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('saveBtn').style.opacity = '0.5';
            document.getElementById('saveBtn').style.cursor = 'not-allowed';
            
            // Re-render attendance in view-only mode
            renderAttendance();
            
            alert('‚úÖ Logged out successfully!');
        }
        
        function renderMemberLists() {
            renderMemberList('femaleList', members.female, 'female');
            renderMemberList('maleList', members.male, 'male');
            renderMemberList('occasionalList', members.occasional, 'occasional');
        }
        
        function renderMemberList(containerId, memberList, category) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = memberList.map((name, index) => `
                <div class="member-item">
                    <span>${index + 1}. ${name}</span>
                </div>
            `).join('');
        }
        
        // Cloud Sync Functions
        function updateSyncStatus(message) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }
        
        // PDF Export Function
        function exportToPDF(reportType) {
            const reportData = reportType === 'quarterly' ? getQuarterlyData() : getYearlyData();
            const title = reportType === 'quarterly' 
                ? `${document.getElementById('quarterSelect').value} ${document.getElementById('quarterYear').value} Attendance Report`
                : `${document.getElementById('yearSelect').value} Annual Attendance Report`;
            
            // Generate analysis
            const analysis = generateAnalysis(reportData);
            
            // Create HTML report
            const reportHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; background: #f5f5f5; }
        .report-container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2d3748; border-bottom: 3px solid #667eea; padding-bottom: 15px; margin-bottom: 30px; }
        .summary { background: #e6f7ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #1890ff; }
        .summary h2 { color: #1890ff; margin-bottom: 15px; font-size: 18px; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .summary-item { background: white; padding: 15px; border-radius: 6px; text-align: center; }
        .summary-item .value { font-size: 28px; font-weight: bold; color: #667eea; }
        .summary-item .label { font-size: 12px; color: #6c757d; margin-top: 5px; }
        .insights { background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #ffc107; }
        .insights h2 { color: #856404; margin-bottom: 15px; font-size: 18px; }
        .insights ul { margin-left: 20px; line-height: 1.8; color: #856404; }
        .member-card { background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #cbd5e0; }
        .member-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .member-name { font-size: 18px; font-weight: 600; color: #2d3748; }
        .member-percentage { font-size: 24px; font-weight: bold; }
        .percentage-good { color: #48bb78; }
        .percentage-warning { color: #ed8936; }
        .percentage-poor { color: #f56565; }
        .stats { font-size: 13px; color: #6c757d; margin-bottom: 12px; }
        .bar-container { height: 30px; background: #e2e8f0; border-radius: 5px; overflow: hidden; display: flex; }
        .bar-present { background: linear-gradient(90deg, #48bb78, #38a169); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; }
        .bar-absent { background: linear-gradient(90deg, #f56565, #e53e3e); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #6c757d; font-size: 12px; }
        @media print { body { background: white; } .report-container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="report-container">
        <h1>üéµ ${title}</h1>
        
        <div class="summary">
            <h2>üìä Summary Statistics</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="value">${analysis.totalMembers}</div>
                    <div class="label">Total Members</div>
                </div>
                <div class="summary-item">
                    <div class="value">${analysis.avgAttendance}%</div>
                    <div class="label">Average Attendance</div>
                </div>
                <div class="summary-item">
                    <div class="value">${analysis.totalDays}</div>
                    <div class="label">Total Days Tracked</div>
                </div>
            </div>
        </div>
        
        <div class="insights">
            <h2>üí° Key Insights</h2>
            <ul>
                ${analysis.insights.map(insight => `<li>${insight}</li>`).join('')}
            </ul>
        </div>
        
        <h2 style="margin-bottom: 20px; color: #2d3748;">Individual Attendance Records</h2>
        ${reportData.map(member => {
            const percentage = parseFloat(member.percentage);
            const presentWidth = member.total > 0 ? (member.present / member.total * 100) : 0;
            const absentWidth = member.total > 0 ? (member.absent / member.total * 100) : 0;
            const colorClass = percentage >= 75 ? 'percentage-good' : percentage >= 50 ? 'percentage-warning' : 'percentage-poor';
            const borderColor = percentage >= 75 ? '#48bb78' : percentage >= 50 ? '#ed8936' : '#f56565';
            
            return `
                <div class="member-card" style="border-left-color: ${borderColor};">
                    <div class="member-header">
                        <span class="member-name">${member.name}</span>
                        <span class="member-percentage ${colorClass}">${member.percentage}%</span>
                    </div>
                    <div class="stats">
                        ‚úÖ Present: ${member.present} days | ‚ùå Absent: ${member.absent} days | üìÖ Total: ${member.total} days
                    </div>
                    <div class="bar-container">
                        <div class="bar-present" style="width: ${presentWidth}%;">
                            ${member.present > 0 ? member.present : ''}
                        </div>
                        <div class="bar-absent" style="width: ${absentWidth}%;">
                            ${member.absent > 0 ? member.absent : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
        
        <div class="footer">
            <p>Generated on ${new Date().toLocaleString()}</p>
            <p>Holy Hymns - Choir Attendance Tracker</p>
        </div>
    </div>
</body>
</html>`;
            
            // Open in new window
            const newWindow = window.open('', '_blank');
            newWindow.document.write(reportHTML);
            newWindow.document.close();
        }
        
        function getQuarterlyData() {
            const quarter = document.getElementById('quarterSelect').value;
            const year = document.getElementById('quarterYear').value;
            
            const quarterMonths = {
                'Q1': [0, 1, 2],
                'Q2': [3, 4, 5],
                'Q3': [6, 7, 8],
                'Q4': [9, 10, 11]
            };
            
            const months = quarterMonths[quarter];
            const allMembers = [...members.female, ...members.male, ...members.occasional];
            
            return allMembers.map(name => {
                let present = 0, absent = 0, total = 0;
                
                Object.keys(attendanceData).forEach(date => {
                    const d = new Date(date);
                    if (d.getFullYear() == year && months.includes(d.getMonth())) {
                        const day = d.getDay();
                        if (day === 0 || day === 6) {
                            total++;
                            if (attendanceData[date][name] === 'P') present++;
                            if (attendanceData[date][name] === 'A') absent++;
                        }
                    }
                });
                
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
                return { name, present, absent, total, percentage };
            });
        }
        
        function getYearlyData() {
            const year = document.getElementById('yearSelect').value;
            const allMembers = [...members.female, ...members.male, ...members.occasional];
            
            return allMembers.map(name => {
                let present = 0, absent = 0, total = 0;
                
                Object.keys(attendanceData).forEach(date => {
                    const d = new Date(date);
                    if (d.getFullYear() == year) {
                        const day = d.getDay();
                        if (day === 0 || day === 6) {
                            total++;
                            if (attendanceData[date][name] === 'P') present++;
                            if (attendanceData[date][name] === 'A') absent++;
                        }
                    }
                });
                
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
                return { name, present, absent, total, percentage };
            });
        }
        
        function generateAnalysis(data) {
            const totalMembers = data.length;
            const avgAttendance = data.length > 0 
                ? (data.reduce((sum, m) => sum + parseFloat(m.percentage), 0) / data.length).toFixed(1)
                : 0;
            const totalDays = data.length > 0 ? Math.max(...data.map(m => m.total)) : 0;
            
            const excellent = data.filter(m => parseFloat(m.percentage) >= 90).length;
            const good = data.filter(m => parseFloat(m.percentage) >= 75 && parseFloat(m.percentage) < 90).length;
            const needsImprovement = data.filter(m => parseFloat(m.percentage) < 50).length;
            const topAttendee = data.reduce((max, m) => parseFloat(m.percentage) > parseFloat(max.percentage) ? m : max, data[0] || {percentage: 0});
            
            const insights = [];
            insights.push(`${excellent} member${excellent !== 1 ? 's' : ''} with excellent attendance (‚â•90%)`);
            insights.push(`${good} member${good !== 1 ? 's' : ''} with good attendance (75-89%)`);
            if (needsImprovement > 0) {
                insights.push(`${needsImprovement} member${needsImprovement !== 1 ? 's' : ''} need${needsImprovement === 1 ? 's' : ''} improvement (<50%)`);
            }
            if (topAttendee.name) {
                insights.push(`Top attendee: ${topAttendee.name} (${topAttendee.percentage}%)`);
            }
            insights.push(`Overall choir attendance rate: ${avgAttendance}%`);
            
            return { totalMembers, avgAttendance, totalDays, insights };
        }
        
        async function syncToGist() {
            if (!gistId || !gistToken) {
                return false;
            }
            
            try {
                updateSyncStatus('‚¨ÜÔ∏è Syncing...');
                
                // Only sync attendance data (members are in JSON file)
                const data = {
                    attendance: attendanceData,
                    lastSync: new Date().toISOString()
                };
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${gistToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'choir-attendance-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    updateSyncStatus(`‚úÖ Synced ${new Date().toLocaleTimeString()}`);
                    return true;
                } else {
                    const errorData = await response.json();
                    console.error('Sync failed:', errorData);
                    updateSyncStatus('‚ùå Sync failed');
                    return false;
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('‚ùå Sync error');
                return false;
            }
        }
        
        async function syncFromGist() {
            if (!gistId) {
                return false;
            }
            
            try {
                updateSyncStatus('‚¨áÔ∏è Syncing...');
                
                const headers = gistToken ? {
                    'Authorization': `token ${gistToken}`
                } : {};
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: headers
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    const file = gist.files['choir-attendance-data.json'];
                    
                    if (file) {
                        const data = JSON.parse(file.content);
                        
                        // Only update attendance (members are loaded from JSON file)
                        if (data.attendance) {
                            attendanceData = data.attendance;
                            localStorage.setItem('choirAttendance', JSON.stringify(attendanceData));
                        }
                        
                        renderAttendance();
                        loadAttendanceForDate();
                        
                        const syncTime = data.lastSync ? new Date(data.lastSync).toLocaleString() : 'Unknown';
                        updateSyncStatus(`‚úÖ Synced ${new Date().toLocaleTimeString()}`);
                        return true;
                    }
                    return false;
                } else {
                    updateSyncStatus('');
                    return false;
                }
            } catch (error) {
                updateSyncStatus('');
                return false;
            }
        }
    </script>
</body>
</html>